name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.24"

jobs:
  # Job 1: Code quality checks
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: Check code formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "The following files are not formatted:"
            gofmt -l .
            exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Check for go mod tidy
        run: |
          go mod tidy
          if [ -n "$(git status --porcelain go.mod go.sum)" ]; then
            echo "go.mod or go.sum is not tidy"
            git diff go.mod go.sum
            exit 1
          fi

  # Job 2: Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."

      - name: Upload Gosec results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: gosec-results.sarif

  # Job 3: Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ridehailing_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run migrations
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
          migrate -path db/migrations -database "postgresql://postgres:postgres@localhost:5432/ridehailing_test?sslmode=disable" up

      - name: Run tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: ridehailing_test
          DB_SSLMODE: disable
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key-for-testing-only
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Generate coverage report
        run: |
          go tool cover -func=coverage.txt
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.txt | tail -1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check coverage threshold
        run: |
          coverage=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
          threshold=50.0
          echo "Current coverage: $coverage%"
          echo "Required threshold: $threshold%"
          if (( $(echo "$coverage < $threshold" | bc -l) )); then
            echo "❌ Coverage $coverage% is below threshold $threshold%"
            exit 1
          fi
          echo "✅ Coverage $coverage% meets threshold $threshold%"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.txt
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Job 4: Build services
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        service:
          [
            auth,
            rides,
            geo,
            payments,
            notifications,
            realtime,
            fraud,
            analytics,
            admin,
            promos,
            scheduler,
            ml-eta,
            mobile,
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build ${{ matrix.service }} service
        run: |
          if [ -d "./cmd/${{ matrix.service }}" ]; then
            go build -v -ldflags="-s -w" -o bin/${{ matrix.service }} ./cmd/${{ matrix.service }}
            echo "✓ Built ${{ matrix.service }} service"
          else
            echo "⚠ Service ${{ matrix.service }} not found, skipping"
            exit 0
          fi

      - name: Upload build artifacts
        if: success() && hashFiles('bin/${{ matrix.service }}') != ''
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.service }}-binary
          path: bin/${{ matrix.service }}
          retention-days: 7

  # Job 5: Integration summary
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, security, test, build]
    if: success()
    steps:
      - name: Success message
        run: |
          echo "## ✅ CI Pipeline Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks completed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code quality (lint, format, vet)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security scan" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Tests with coverage threshold" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Build all services" >> $GITHUB_STEP_SUMMARY
